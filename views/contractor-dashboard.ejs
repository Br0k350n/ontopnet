<!DOCTYPE html>
<html lang="en">
    <%- include('partials/head', {title: "Contractor Dashboard", tag: "Contractor", isAdmin: true}); %>
<body>
    <%- include('partials/header', {session: session}); %>
    
    <div class="w-full layout-container lc-home">
        <div class="index-layout">
            <%- include('partials/contractor-cat'); %>
            <div class="body-container">
                <main class="index-content">
                    <section class="content">
                        
                        <!-- Recent Discount Codes Section -->
                        <div class="table-container" id="recent-discount-codes">
                            <h3>Recent Discount Codes</h3>
                            <% if (discountCodes && discountCodes.length > 0) { %>
                              <table>
                                <thead>
                                  <tr>
                                    <th>#</th>
                                    <th>Discount Code</th>
                                    <th>Discount (%)</th>
                                    <th>Created At</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <% discountCodes.forEach((code, index) => { %>
                                    <tr>
                                      <td><%= index + 1 %></td>
                                      <td><%= code.code %></td>
                                      <td><%= code.discount %></td>
                                      <td>
                                        <time class="local-time" datetime="<%= new Date(code.created_at).toISOString() %>">
                                          <%= new Date(code.created_at).toUTCString() %>
                                        </time>
                                      </td>
                                    </tr>
                                  <% }); %>
                                </tbody>
                              </table>
                            <% } else { %>
                              <p>No discount codes created yet.</p>
                            <% } %>
                        </div>
                        
                        <!-- Referred Users Section -->
                        <div class="table-container" id="referred-users" style="margin-top: 40px;">
                            <h3>Referred Users</h3>
                            <table>
                              <thead>
                                <tr>
                                  <th>#</th>
                                  <th>Username</th>
                                  <th>Email</th>
                                  <th>Discord</th>
                                  <th>Referral Date</th>
                                </tr>
                              </thead>
                              <tbody>
                                <% if (referredUsers.length === 0) { %>
                                  <tr>
                                    <td colspan="5" class="no-referred-users">
                                      <span class="emoji">ðŸ˜ž</span> 
                                      <p>You haven't referred anyone yet!</p>
                                    </td>
                                  </tr>
                                <% } else { %>
                                  <% referredUsers.forEach((user, index) => { %>
                                    <tr>
                                      <td><%= index + 1 + (currentPage - 1) * itemsPerPage %></td>
                                      <td><%= user.username %></td>
                                      <td><%= user.email %></td>
                                      <td><%= user.discord_id || "Not Linked" %></td>
                                      <td>
                                        <time class="local-time" datetime="<%= new Date(user.created_at).toISOString() %>">
                                          <%= new Date(user.created_at).toUTCString() %>
                                        </time>
                                      </td>
                                    </tr>
                                  <% }); %>
                                <% } %>
                              </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination">
                          <% const totalPages = Math.ceil(totalUsers / itemsPerPage); %>
                          <!-- Previous Button -->
                          <button class="pagination-btn" <% if (currentPage === 1) { %>disabled<% } %> data-page="<%= currentPage - 1 %>" onclick="window.location.href='/contractor/dashboard?page=<%= currentPage - 1 %>'">Â« Previous</button>
                          
                          <!-- Page Number Buttons -->
                          <% for (let i = 1; i <= totalPages; i++) { %>
                            <button class="pagination-btn <%= i === currentPage ? 'active' : '' %>" data-page="<%= i %>" onclick="window.location.href='/contractor/dashboard?page=<%= i %>'"><%= i %></button>
                          <% } %>
                          
                          <!-- Next Button -->
                          <button class="pagination-btn" <% if (currentPage === totalPages) { %>disabled<% } %> data-page="<%= currentPage + 1 %>" onclick="window.location.href='/contractor/dashboard?page=<%= currentPage + 1 %>'">Next Â»</button>
                        </div>
                        
                        <!-- Discount Code Section -->
                        <div class="discount-code-section" style="margin-top: 40px;">
                          <h3>Create a Discount Code</h3>
                          <form action="/contractor/discount-codes" method="POST" onsubmit="return validateDiscountCode();">
                              <!-- Auto-generation is enabled, so no manual code input is required -->                              
                              <div class="form-group">
                                  <label for="discount">Discount Percentage (%):</label>
                                  <input type="number" id="discount" name="discount" placeholder="Max 10%" min="0" max="10" step="0.1" required>
                              </div>
                              <button type="submit">Create Discount Code</button>
                          </form>
                        </div>
                        
                    </section>
                </main>
            </div>
        </div>
    </div>

    <%- include('partials/footer'); %>

    <!-- Modal for discount success pop-up -->
    <div id="discountSuccessModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="document.getElementById('discountSuccessModal').style.display='none'">&times;</span>
        <p>Discount code created successfully!</p>
      </div>
    </div>

    <script>
      // Client-side validation to ensure discount does not exceed 10%
      function validateDiscountCode() {
          const discountInput = document.getElementById('discount');
          const discountValue = parseFloat(discountInput.value);
          if (discountValue > 10) {
              alert('Discount cannot exceed 10%');
              return false;
          }
          return true;
      }
    </script>

    <style>
        /* Styling for the discount code section */
        .discount-code-section {
            padding: 20px;
            margin-top: 30px;
            border-radius: 5px;
            background-color: #34495e;
            color: #fff;
        }
        .discount-code-section h3 {
            margin-bottom: 15px;
        }
        .discount-code-section .form-group {
            margin-bottom: 15px;
        }
        .discount-code-section label {
            display: block;
            margin-bottom: 5px;
            color: #fff;
        }
        .discount-code-section input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .discount-code-section button {
            padding: 8px 16px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .discount-code-section button:hover {
            background-color: #0056b3;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border-radius: 5px;
            width: 300px;
            text-align: center;
        }
        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
    </style>

    <% if (discountSuccess) { %>
      <script>
        document.getElementById('discountSuccessModal').style.display = 'block';
      </script>
    <% } %>

</body>
</html>
